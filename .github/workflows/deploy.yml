name: Report API EC2 ë°°í¬
on:
  push:
    branches: feat/restful
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: JDK 17 ì„¤ì¹˜ (ë¹Œë“œìš©)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ë°±ì—”ë“œ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ë¹Œë“œ
        run: |
          cd han_noon_back/Report
          chmod +x gradlew
          ./gradlew clean bootJar
      
      - name: SSH í”„ë¼ì´ë¹— í‚¤ ì €ì¥
        run: |
          echo "${{ secrets.EC2_KEY }}" > ec2_key.pem
          chmod 600 ec2_key.pem
      
      - name: .env íŒŒì¼ ìƒì„± ë° EC2ë¡œ ë³µì‚¬
        run: |
          cat > report.env << EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          DB_URL=${{ secrets.DB_URL }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF
          
          scp -i ec2_key.pem -o StrictHostKeyChecking=no \
            report.env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/.env
      
      - name: ë¹Œë“œëœ JAR íŒŒì¼ì„ EC2ë¡œ ë³µì‚¬
        run: |
          scp -i ec2_key.pem -o StrictHostKeyChecking=no \
            han_noon_back/Report/build/libs/payment_guard-*.jar \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/report-api.jar
      
      - name: EC2ì— SSH ì ‘ì†í•´ Report API ì„œë²„ ì¬ì‹œì‘
        run: |
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
              # ê¸°ì¡´ Report API í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
              pkill -f 'java -jar.*report-api.jar' || true
              sleep 5
          
              # ê¸°ì¡´ ë¦¬í¬íŠ¸ API ë¡œê·¸ íŒŒì¼ ì‚­ì œ
              rm -f report-api.log
              
              # Report API ì‹œì‘ (í¬íŠ¸ 8081, ê¸°ì¡´ app.jarì™€ ë…ë¦½)
              nohup java -jar /home/${USER}/report-api.jar > report-api.log 2>&1 &
          
              # ì‹œì‘ í™•ì¸
              sleep 15
              if pgrep -f 'java -jar.*report-api.jar' > /dev/null; then
                echo "âœ… Report API ì‹œì‘ ì„±ê³µ (í¬íŠ¸ 8081)"
                echo "ğŸ“Š ê¸°ì¡´ Consumer API (í¬íŠ¸ 8080)ì™€ í•¨ê»˜ ì‹¤í–‰ ì¤‘"
              else
                echo "âŒ Report API ì‹œì‘ ì‹¤íŒ¨"
                tail -20 report-api.log
                exit 1
              fi
              
              # í—¬ìŠ¤ì²´í¬
              sleep 5
              if curl -f http://localhost:8081/api/reports/health > /dev/null 2>&1; then
                echo "ğŸ’š Report API í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              else
                echo "ğŸ’¥ Report API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                tail -20 report-api.log
              fi
              
              # ë‘ ì„œë¹„ìŠ¤ ëª¨ë‘ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
              echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Java ì• í”Œë¦¬ì¼€ì´ì…˜:"
              ps aux | grep 'java -jar' | grep -v grep || true
          EOF
